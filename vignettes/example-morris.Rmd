---
title: "example-morris"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{example-morris}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(AquacropOnR)
```

## Example Morris method

For sensitivity analysis using the `morris` method you first design the morris sampling scheme and the simulations.
Based on these results, you can then define for which level you want to calculate the elemental effects.
First we run the Morris method using the `aquacrop_morris` function: 


```{r morris1, warning=FALSE, message=FALSE}

p <- aquacrop_morris(situation = "S_01", 
                     backgroundpar=Spinach, 
                     cycle_length = 70, 
                     r = 20, 
                     binf=c(rt_max = 0.12, cgc = 0.1), 
                     bsup = c(rt_max = 0.55, cgc = 0.21), 
                     outvars = c("Biomass", "YSdryS"))

``` 

Then we create the interpretable dataframe from the elemental effects matrix: 

```{r morris2, warning=FALSE,message=FALSE}
EE <- p$ee %>% melt(value.name = "ee", varnames = c("traject", "par", "DAP", "output"))

```

If you would have multiple scenarios in your analysis, then the DAP values can be split up by scenario:

```{r morris3, warning=FALSE, message=FALSE}

EE <- EE %>% dplyr::mutate(Scenario = (DAP %/% 70)+1,
                           DAP = DAP %% 70)

```

We can then choose the level of integration at which we want to summarise the elemental effects:

- By DAP and output variable

```{r morris4, warning=FALSE, message=FALSE}
mu_star1 <- EE %>%
  group_by(par, DAP, output) %>%
  summarise(mu = mean(ee),
            mu_star = mean(abs(ee)),
            sigma = sd(ee))

ggplot(mu_star1) +
  facet_wrap(facets = vars(output), nrow=2) +
  theme_bw() +
  geom_point(mapping = aes(x=DAP, y=mu_star, color = par))

```

- By output variable

```{r morris5, warning=FALSE, message=FALSE}
mu_star2 <- EE %>% 
  group_by(par, output) %>%
  summarise(mu = mean(ee),
            mu_star = mean(abs(ee)),
            sigma = sd(ee))

ggplot(mu_star2) +
  facet_wrap(facets = vars(output), nrow=2) +
  theme_bw() +
  geom_point(mapping = aes(x=mu_star, y=sigma, color = par))

```


